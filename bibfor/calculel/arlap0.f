      SUBROUTINE ARLAP0(MAIL  ,TYPMAI,NORM  ,GRMAMA,DEGMAX,
     &                  NGRMA1,NOMBO1,NGRMA2,NOMBO2,NOMCOL,
     &                  NOMAPP,NOMARB,NBMAC ,TRAVR ,NHAPP ,
     &                  NAPP)
C
C            CONFIGURATION MANAGEMENT OF EDF VERSION
C MODIF CALCULEL  DATE 20/07/2009   AUTEUR MEUNIER S.MEUNIER 
C ======================================================================
C COPYRIGHT (C) 1991 - 2009  EDF R&D                  WWW.CODE-ASTER.ORG
C THIS PROGRAM IS FREE SOFTWARE; YOU CAN REDISTRIBUTE IT AND/OR MODIFY  
C IT UNDER THE TERMS OF THE GNU GENERAL PUBLIC LICENSE AS PUBLISHED BY  
C THE FREE SOFTWARE FOUNDATION; EITHER VERSION 2 OF THE LICENSE, OR     
C (AT YOUR OPTION) ANY LATER VERSION.                                   
C                                                                       
C THIS PROGRAM IS DISTRIBUTED IN THE HOPE THAT IT WILL BE USEFUL, BUT   
C WITHOUT ANY WARRANTY; WITHOUT EVEN THE IMPLIED WARRANTY OF            
C MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. SEE THE GNU      
C GENERAL PUBLIC LICENSE FOR MORE DETAILS.                              
C                                                                       
C YOU SHOULD HAVE RECEIVED A COPY OF THE GNU GENERAL PUBLIC LICENSE     
C ALONG WITH THIS PROGRAM; IF NOT, WRITE TO EDF R&D CODE_ASTER,         
C   1 AVENUE DU GENERAL DE GAULLE, 92141 CLAMART CEDEX, FRANCE.         
C ======================================================================
C RESPONSABLE MEUNIER S.MEUNIER
C
      IMPLICIT NONE
      CHARACTER*8   MAIL
      CHARACTER*16  TYPMAI
      CHARACTER*24  NOMCOL
      CHARACTER*10  NORM
      CHARACTER*24  NOMAPP
      CHARACTER*24  GRMAMA
      CHARACTER*16  NOMBO1,NOMBO2
      CHARACTER*16  NOMARB
      CHARACTER*24  NGRMA1,NGRMA2
      INTEGER       NHAPP
      INTEGER       DEGMAX
      INTEGER       NBMAC
      INTEGER       NAPP
      CHARACTER*16  TRAVR
C
C ----------------------------------------------------------------------
C
C APPARIEMENT DE DEUX GROUPES DE MAILLE PAR LA METHODE
C BOITES ENGLOBANTES + ARBRE BSP
C
C ROUTINE PRINCIPALE D'APPARIEMENT
C
C ----------------------------------------------------------------------
C
C
C APPARIEMENT DE NOMBO1 SUR NOMBO2, PAR FILTRAGE DES MAILLES SUR UNE
C ZONE DE COLLAGE (ZONE RESTREINTE DE GRMA2)
C
C
C IN  MAIL   : NOM UTILISATEUR DU MAILLAGE
C IN  TYPMAI : SD CONTENANT NOM DES TYPES ELEMENTS (&&CATA.NOMTM)
C IN  NORM   : NOM DE LA SD POUR STOCKAGE DES NORMALES
C IN  GRMAMA : GRAPHE MAILLE-MAILLE ATTACHE A GRMA2 (VOIR ROUTINE
C              GRMAMA)
C                 MAILLE -> LISTE DES MAILLES VOISINES
C                 (IE. DIFFERENTES ET PARTAGEANT UN NOEUD)
C IN  DEGMAX : DEGRE MAXIMUM DU GRAPHE GRMAMA
C IN  NGRMA1 : NOM DE LA SD DE STOCKAGE MAILLES GROUP_MA_1
C                SIMPLE LISTE CONTENANT LES NUMEROS ABSOLUS DES MAILLES
C                A APPARIER (LONG: NBMA1)
C IN  NOMBO1 : NOM DE LA SD DES BOITES POUR LES MAILLES DU GRMA1
C IN  NGRMA2 : NOM DE LA SD DE STOCKAGE MAILLES GROUP_MA_2
C                SIMPLE LISTE CONTENANT LES NUMEROS ABSOLUS DES MAILLES
C                A APPARIER (LONG: NBMA2)
C IN  NOMBO2 : NOM DE LA SD DES BOITES POUR LES MAILLES DU GRMA2
C IN  NOMCOL : VECTEUR INDIQUANT SI MAILLE A COLLER, DE LONGUEUR
C               NBMA1
C OUT NOMAPP : GRAPHE D'APPARIEMENT
C IN  NOMARB : ARBRE D'APPARIEMENT
C IN  NBMAC  : NOMBRE DE MAILLES DE LA ZONE DE COLLAGE
C I/O TRAVR  : VECTEUR DE REELS DE TRAVAIL DE LONGUEUR 12+276*NHAPP
C IN  NHAPP  : ECHANTILLONNAGE DE LA FRONTIERE
C OUT NAPP   : NOMBRE DE COUPLES D'APPARIEMENT
C
C SD DE SORTIE
C NOMAPP : GRAPHE D'APPARIEMENT (XC V I NUMERO VARIABLE)
C              MAILLE DOMAINE 1 -> MAILLES DOMAINE 2 EN VIS-A-VIS
C              [MA1] : (MA2.1, MA2.2, MA2.3, ...)
C                      AVEC MA* INDEX NOM*.GROUPEMA
C
C --------- DEBUT DECLARATIONS NORMALISEES  JEVEUX ---------------------
C
      CHARACTER*32  JEXATR,JEXNUM
      INTEGER            ZI
      COMMON  / IVARJE / ZI(1)
      REAL*8             ZR
      COMMON  / RVARJE / ZR(1)
      COMPLEX*16         ZC
      COMMON  / CVARJE / ZC(1)
      LOGICAL            ZL
      COMMON  / LVARJE / ZL(1)
      CHARACTER*8        ZK8
      CHARACTER*16                ZK16
      CHARACTER*24                          ZK24
      CHARACTER*32                                    ZK32
      CHARACTER*80                                              ZK80
      COMMON  / KVARJE / ZK8(1) , ZK16(1) , ZK24(1) , ZK32(1) , ZK80(1)
C
C --- FIN DECLARATIONS NORMALISEES JEVEUX ------------------------------
C
      INTEGER       JCOOR,JCONNX,JCOLCU,JTYPMA
      INTEGER       JGRMA1,JBO1DI,JBO1MM,JBO1PA
      INTEGER       JGRMA2,JBO2DI,JBO2MM,JBO2PA
      INTEGER       JARBCE,JARBLI,JGRMAM,JGRMLC
      INTEGER       JTRAVR,JVOISI(2),JFILTR,JLIENT,JLIRES,JNVIVI
      INTEGER       DIME,NAPT,NVIS0,NBMA1,NBMA2
      INTEGER       IRET
      INTEGER       JNORM
      INTEGER       IMA1,JAPPM1,JLIMA1
      REAL*8        CNOEUD(81)
      INTEGER       JTYPMM,JCOLM
      REAL*8        R8MAEM,R8BID
      INTEGER       IFM,NIV
C
      CHARACTER*6  NOMPRO
      PARAMETER   (NOMPRO='ARLAP0')
C
C ----------------------------------------------------------------------
C====
C 1. PREALABLES
C====
C
      CALL JEMARQ()
      CALL INFDBG('ARLEQUIN',IFM,NIV)
C
C --- INITIALISATIONS
C
      CALL JEVEUO(TYPMAI,'L',JTYPMM)
      R8BID = R8MAEM()
      CALL R8INIR(81,R8BID,CNOEUD,1)
C
C --- FILTRE
C
      CALL JEVEUO(NOMCOL(1:24),'E',JCOLM)
C
C --- LECTURE DONNEES MAILLAGE
C
      CALL JEVEUO(MAIL(1:8)//'.COORDO    .VALE','L',JCOOR)
      CALL JEVEUO(MAIL(1:8)//'.CONNEX','L',JCONNX)
      CALL JEVEUO(JEXATR(MAIL(1:8)//'.CONNEX','LONCUM'),'L',JCOLCU)
      CALL JEVEUO(MAIL(1:8)//'.TYPMAIL','L',JTYPMA)
C
C --- LECTURE DONNEES NORMALES
C
      CALL JEEXIN(NORM,IRET)
      IF (IRET.NE.0) THEN
        CALL JEVEUO(NORM,'L',JNORM)
      ENDIF
C
C --- LECTURE DONNEES GROUPE DE MAILLES
C
      CALL JEVEUO(NGRMA1,'L',JGRMA1)
      CALL JEVEUO(NGRMA2,'L',JGRMA2)
C
C --- LECTURE DONNEES BOITES APPARIEMENT
C
      CALL JEVEUO(NOMBO1(1:16)//'.DIME','L'  ,JBO1DI)
      CALL JEVEUO(NOMBO1(1:16)//'.MINMAX','L',JBO1MM)
      CALL JEVEUO(NOMBO1(1:16)//'.PAN','L'   ,JBO1PA)
      DIME  = ZI(JBO1DI)
      NBMA1 = ZI(JBO1DI+1)
C
      CALL JEVEUO(NOMBO2(1:16)//'.DIME','L'  ,JBO2DI)
      CALL JEVEUO(NOMBO2(1:16)//'.MINMAX','L',JBO2MM)
      CALL JEVEUO(NOMBO2(1:16)//'.PAN','L'   ,JBO2PA)
      NBMA2 = ZI(JBO2DI+1)
C
C --- LECTURE DONNEES GRAPHE MAILLE-MAILLE
C
      IF (NBMA2.GT.1) THEN
        CALL JEVEUO(GRMAMA,'L',JGRMAM)
        CALL JEVEUO(JEXATR(GRMAMA,'LONCUM'),'L',JGRMLC)
      ENDIF
C
C --- LECTURE DONNEES ARBRE APPARIEMENT
C
      CALL JEVEUO(NOMARB(1:16)//'.CELL','L',JARBCE)
      CALL JEVEUO(NOMARB(1:16)//'.LIMA','L',JARBLI)
C
C --- CREATION GRAPHE APPARIEMENT
C
      CALL JECREC(NOMAPP,'V V I','NU','CONTIG','VARIABLE',NBMA1)
C
C --- LECTURE VECTEUR DE TRAVAIL
C
      CALL JEVEUO(TRAVR,'E',JTRAVR)
C
C --- ALLOCATIONS OBJETS TEMPORAIRES
C
      NVIS0 = 2*DEGMAX*MAX(NBMAC,NBMA2)
      CALL WKVECT('&&'//NOMPRO//'.VOISIN1',      'V V I',NBMA2,
     &            JVOISI(1))
      CALL WKVECT('&&'//NOMPRO//'.VOISIN2',      'V V I',NBMA2,
     &            JVOISI(2))
      CALL WKVECT('&&'//NOMPRO//'.FILTRE',       'V V L',NBMA2  ,JFILTR)
      CALL WKVECT('&&'//NOMPRO//'.LISTE.ENTETE', 'V V I',NBMA1  ,JLIENT)
      CALL WKVECT('&&'//NOMPRO//'.LISTE.RESERVE','V V I',2*NVIS0,JLIRES)
      CALL WKVECT('&&'//NOMPRO//'.NVISAVIS',     'V V I',NBMA1  ,JNVIVI)
C
C====
C 2. APPARIEMENT
C====
C
      CALL ARLAP1(DIME       ,ZI(JARBCE),JARBLI    ,
     &            ZI(JBO1DI) ,JBO1MM    ,JBO1PA    ,
     &            ZI(JBO2DI) ,JBO2MM    ,JBO2PA    ,
     &            NVIS0      ,JLIRES    ,
     &            ZR(JNORM)  ,JGRMAM    ,ZI(JGRMLC),
     &            MAIL       ,ZI(JCONNX),ZI(JCOLCU),ZR(JCOOR),
     &            ZK8(JTYPMM),ZI(JTYPMA),
     &            NBMA1      ,ZI(JGRMA1),
     &            NBMA2      ,ZI(JGRMA2),
     &            NHAPP      ,ZL(JCOLM) ,NBMAC     ,
     &            ZL(JFILTR) ,ZI(JLIENT),ZI(JNVIVI),JTRAVR   ,JVOISI,
     &            NAPP       ,NAPT                                  )
C
C====
C 3. FIN
C====
C
      IF (NBMAC.EQ.0) THEN
        CALL U2MESS('F','ARLEQUIN_12')
      ENDIF
C
C --- COPIE LISTE -> SD. APPARIEMENT
C
      CALL JEECRA(NOMAPP,'LONT',NAPT,' ')
      DO 10 , IMA1 = 1, NBMA1
        CALL JECROC(JEXNUM(NOMAPP,IMA1))
        CALL JEECRA(JEXNUM(NOMAPP,IMA1),'LONMAX',ZI(JNVIVI-1+IMA1),' ')
        IF (.NOT.ZL(JCOLM+IMA1-1)) GOTO 10
        CALL JEVEUO(JEXNUM(NOMAPP,IMA1),'E',JAPPM1)
        JLIMA1 = ZI(JLIENT-1+IMA1)
  11    CONTINUE
        ZI(JAPPM1) = ZI(JLIMA1)
        JAPPM1 = JAPPM1 + 1
        JLIMA1 = ZI(JLIMA1+1)
        IF (JLIMA1.NE.0) GOTO 11
  10  CONTINUE
C
C --- DESALLOCATIONS
C
      CALL JEDETR('&&'//NOMPRO//'.VOISIN1')
      CALL JEDETR('&&'//NOMPRO//'.VOISIN2')
      CALL JEDETR('&&'//NOMPRO//'.FILTRE')
      CALL JEDETR('&&'//NOMPRO//'.LISTE.ENTETE')
      CALL JEDETR('&&'//NOMPRO//'.LISTE.RESERVE')
      CALL JEDETR('&&'//NOMPRO//'.NVISAVIS')
      CALL JEDEMA()
C
      END
