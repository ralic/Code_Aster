      SUBROUTINE BTDMSR(NB1,NB2,KSI3S2,INTSR,XR,EPAIS,VECTPT,
     &                                           HSJ1M,HSJ1S,BTDM,BTDS)
C            CONFIGURATION MANAGEMENT OF EDF VERSION
C MODIF ELEMENTS  DATE 17/12/2007   AUTEUR DESROCHES X.DESROCHES 
C ======================================================================
C COPYRIGHT (C) 1991 - 2001  EDF R&D                  WWW.CODE-ASTER.ORG
C THIS PROGRAM IS FREE SOFTWARE; YOU CAN REDISTRIBUTE IT AND/OR MODIFY
C IT UNDER THE TERMS OF THE GNU GENERAL PUBLIC LICENSE AS PUBLISHED BY
C THE FREE SOFTWARE FOUNDATION; EITHER VERSION 2 OF THE LICENSE, OR   
C (AT YOUR OPTION) ANY LATER VERSION.                                 
C
C THIS PROGRAM IS DISTRIBUTED IN THE HOPE THAT IT WILL BE USEFUL, BUT 
C WITHOUT ANY WARRANTY; WITHOUT EVEN THE IMPLIED WARRANTY OF          
C MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. SEE THE GNU    
C GENERAL PUBLIC LICENSE FOR MORE DETAILS.                            
C
C YOU SHOULD HAVE RECEIVED A COPY OF THE GNU GENERAL PUBLIC LICENSE   
C ALONG WITH THIS PROGRAM; IF NOT, WRITE TO EDF R&D CODE_ASTER,       
C    1 AVENUE DU GENERAL DE GAULLE, 92141 CLAMART CEDEX, FRANCE.      
C ======================================================================
C
      IMPLICIT REAL*8 (A-H,O-Z)
      INTEGER NB1,NB2,INTE,INTSR
      REAL*8 XR(*),EPAIS,VECTPT(9,2,3)
      REAL*8 HSJ1M(3,9),HSJ1S(2,9),BTDM(4,3,42),BTDS(4,2,42)
      REAL*8 DNSDSM(9,42),DNSDS(9,42)
      REAL*8 KSI3S2
      COMMON/DNSMS/DNSDSM,DNSDS
C
         L1= 44
         L2= 76
         L3=351
         L4=387
         L5=423
C
      DO 15 I=1,9
      DO 16 J=1,5*NB1+2
         DNSDSM(I,J)=0.D0
          DNSDS(I,J)=0.D0
         IF (I.LE.3) BTDM(INTSR,I,J)=0.D0
         IF (I.LE.2) BTDS(INTSR,I,J)=0.D0
 16   CONTINUE
 15   CONTINUE
C
         INTSR1=8*(INTSR-1)
         INTSR2=9*(INTSR-1)
C
C                         DN             DN   
C     CONSTRUCTION DE   ------    ET   ------   AUX PTS DE GAUSS REDUITS
C                        DQSI  M        DQSI  
C
         I1=L1+INTSR1
         I2=L2+INTSR1
         I3=L3+INTSR2
         I4=L4+INTSR2
         I5=L5+INTSR2
C
      DO 30 J=1,NB1
         J1=5*(J-1)
         DNSDSM(1,J1+1)=XR(I1+J)
         DNSDSM(2,J1+1)=XR(I2+J)
C
         DNSDSM(4,J1+2)=XR(I1+J)
         DNSDSM(5,J1+2)=XR(I2+J)
C
         DNSDSM(7,J1+3)=XR(I1+J)
         DNSDSM(8,J1+3)=XR(I2+J)
C
          DNSDS(1,J1+1)=XR(I1+J)
          DNSDS(1,J1+4)=-KSI3S2*XR(I4+J)*EPAIS*VECTPT(J,2,1)
          DNSDS(1,J1+5)= KSI3S2*XR(I4+J)*EPAIS*VECTPT(J,1,1)
C
          DNSDS(2,J1+1)=XR(I2+J)
          DNSDS(2,J1+4)=-KSI3S2*XR(I5+J)*EPAIS*VECTPT(J,2,1)
          DNSDS(2,J1+5)= KSI3S2*XR(I5+J)*EPAIS*VECTPT(J,1,1)
C
          DNSDS(3,J1+4)=-XR(I3+J)/2*EPAIS*VECTPT(J,2,1)
          DNSDS(3,J1+5)= XR(I3+J)/2*EPAIS*VECTPT(J,1,1)
C
          DNSDS(4,J1+2)=XR(I1+J)
          DNSDS(4,J1+4)=-KSI3S2*XR(I4+J)*EPAIS*VECTPT(J,2,2)
          DNSDS(4,J1+5)= KSI3S2*XR(I4+J)*EPAIS*VECTPT(J,1,2)
C
          DNSDS(5,J1+2)=XR(I2+J)
          DNSDS(5,J1+4)=-KSI3S2*XR(I5+J)*EPAIS*VECTPT(J,2,2)
          DNSDS(5,J1+5)= KSI3S2*XR(I5+J)*EPAIS*VECTPT(J,1,2)
C
          DNSDS(6,J1+4)=-XR(I3+J)/2*EPAIS*VECTPT(J,2,2)
          DNSDS(6,J1+5)= XR(I3+J)/2*EPAIS*VECTPT(J,1,2)
C
          DNSDS(7,J1+3)=XR(I1+J)
          DNSDS(7,J1+4)=-KSI3S2*XR(I4+J)*EPAIS*VECTPT(J,2,3)
          DNSDS(7,J1+5)= KSI3S2*XR(I4+J)*EPAIS*VECTPT(J,1,3)
C
          DNSDS(8,J1+3)=XR(I2+J)
          DNSDS(8,J1+4)=-KSI3S2*XR(I5+J)*EPAIS*VECTPT(J,2,3)
          DNSDS(8,J1+5)= KSI3S2*XR(I5+J)*EPAIS*VECTPT(J,1,3)
C
          DNSDS(9,J1+4)=-XR(I3+J)/2*EPAIS*VECTPT(J,2,3)
          DNSDS(9,J1+5)= XR(I3+J)/2*EPAIS*VECTPT(J,1,3)
 30   CONTINUE
C
          DNSDS(1,5*NB1+1)=-KSI3S2*XR(I4+NB2)*EPAIS*VECTPT(NB2,2,1)
          DNSDS(1,5*NB1+2)= KSI3S2*XR(I4+NB2)*EPAIS*VECTPT(NB2,1,1)
C
          DNSDS(2,5*NB1+1)=-KSI3S2*XR(I5+NB2)*EPAIS*VECTPT(NB2,2,1)
          DNSDS(2,5*NB1+2)= KSI3S2*XR(I5+NB2)*EPAIS*VECTPT(NB2,1,1)
C
          DNSDS(3,5*NB1+1)=-XR(I3+NB2)/2*EPAIS*VECTPT(NB2,2,1)
          DNSDS(3,5*NB1+2)= XR(I3+NB2)/2*EPAIS*VECTPT(NB2,1,1)
C
          DNSDS(4,5*NB1+1)=-KSI3S2*XR(I4+NB2)*EPAIS*VECTPT(NB2,2,2)
          DNSDS(4,5*NB1+2)= KSI3S2*XR(I4+NB2)*EPAIS*VECTPT(NB2,1,2)
C
          DNSDS(5,5*NB1+1)=-KSI3S2*XR(I5+NB2)*EPAIS*VECTPT(NB2,2,2)
          DNSDS(5,5*NB1+2)= KSI3S2*XR(I5+NB2)*EPAIS*VECTPT(NB2,1,2)
C
          DNSDS(6,5*NB1+1)=-XR(I3+NB2)/2*EPAIS*VECTPT(NB2,2,2)
          DNSDS(6,5*NB1+2)= XR(I3+NB2)/2*EPAIS*VECTPT(NB2,1,2)
C
          DNSDS(7,5*NB1+1)=-KSI3S2*XR(I4+NB2)*EPAIS*VECTPT(NB2,2,3)
          DNSDS(7,5*NB1+2)= KSI3S2*XR(I4+NB2)*EPAIS*VECTPT(NB2,1,3)
C
          DNSDS(8,5*NB1+1)=-KSI3S2*XR(I5+NB2)*EPAIS*VECTPT(NB2,2,3)
          DNSDS(8,5*NB1+2)= KSI3S2*XR(I5+NB2)*EPAIS*VECTPT(NB2,1,3)
C
          DNSDS(9,5*NB1+1)=-XR(I3+NB2)/2*EPAIS*VECTPT(NB2,2,3)
          DNSDS(9,5*NB1+2)= XR(I3+NB2)/2*EPAIS*VECTPT(NB2,1,3)
C
C     CONSTRUCTION DE BTILDM = HFM * S * JTILD-1 * DNSDSM  : (3,5*NB1+2)
C
      DO 40  I=1,3
      DO 50 JB=1,NB1
      DO 60  J=1,3
         J1=J+5*(JB-1)
         BTDM(INTSR,I,J1)=0.D0
      DO 70  K=1,2
         K1=K+3*(J-1)
         BTDM(INTSR,I,J1)=BTDM(INTSR,I,J1)+HSJ1M(I,K1)*DNSDSM(K1,J1)
 70   CONTINUE
 60   CONTINUE
 50   CONTINUE
         BTDM(INTSR,I,5*NB1+1)=0.D0
         BTDM(INTSR,I,5*NB1+2)=0.D0
 40   CONTINUE
C
C     CONSTRUCTION DE BTILDS = HS * S * JTILD-1 * DNSDS  : (2,5*NB1+2)
C
      DO  80  I=1,2
      DO  90 JB=1,NB1
      DO 100  J=1,5
          J1=J+5*(JB-1)
          BTDS(INTSR,I,J1)=0
      IF (J.LE.3) THEN
      DO 110  K=1,2
          K1=K+3*(J-1)
          BTDS(INTSR,I,J1)=BTDS(INTSR,I,J1)+HSJ1S(I,K1)*DNSDS(K1,J1)
 110  CONTINUE
      ELSE
      DO 120  K=1,9
          BTDS(INTSR,I,J1)=BTDS(INTSR,I,J1)+HSJ1S(I,K)*DNSDS(K,J1)
 120  CONTINUE
      ENDIF
 100  CONTINUE
 90   CONTINUE
      DO 130  J=1,2
          J1=5*NB1+J
          BTDS(INTSR,I,J1)=0.D0
      DO 140  K=1,9
          BTDS(INTSR,I,J1)=BTDS(INTSR,I,J1)+HSJ1S(I,K)*DNSDS(K,J1)
 140  CONTINUE
 130  CONTINUE
 80   CONTINUE
      END
