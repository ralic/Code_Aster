      SUBROUTINE TE0532(OPTION,NOMTE)
      IMPLICIT   NONE
      INCLUDE 'jeveux.h'

      CHARACTER*16 OPTION,NOMTE

C            CONFIGURATION MANAGEMENT OF EDF VERSION
C MODIF ELEMENTS  DATE 15/01/2013   AUTEUR DELMAS J.DELMAS 
C ======================================================================
C COPYRIGHT (C) 1991 - 2013  EDF R&D                  WWW.CODE-ASTER.ORG
C THIS PROGRAM IS FREE SOFTWARE; YOU CAN REDISTRIBUTE IT AND/OR MODIFY
C IT UNDER THE TERMS OF THE GNU GENERAL PUBLIC LICENSE AS PUBLISHED BY
C THE FREE SOFTWARE FOUNDATION; EITHER VERSION 2 OF THE LICENSE, OR
C (AT YOUR OPTION) ANY LATER VERSION.
C
C THIS PROGRAM IS DISTRIBUTED IN THE HOPE THAT IT WILL BE USEFUL, BUT
C WITHOUT ANY WARRANTY; WITHOUT EVEN THE IMPLIED WARRANTY OF
C MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. SEE THE GNU
C GENERAL PUBLIC LICENSE FOR MORE DETAILS.
C
C YOU SHOULD HAVE RECEIVED A COPY OF THE GNU GENERAL PUBLIC LICENSE
C ALONG WITH THIS PROGRAM; IF NOT, WRITE TO EDF R&D CODE_ASTER,
C   1 AVENUE DU GENERAL DE GAULLE, 92141 CLAMART CEDEX, FRANCE.
C ======================================================================
C RESPONSABLE GENIAUT S.GENIAUT
C.......................................................................
C
C                CONTACT X-FEM MÉTHODE CONTINUE :
C         CONVERGENCE DE LA BOUCLE SUR LES CONTRAINTES ACTIVES
C
C
C  OPTION : 'XCVBCA' (X-FEM CONVERGENCE BOUCLE CONTRAINTES ACTIVES )

C  ENTREES  ---> OPTION : OPTION DE CALCUL
C           ---> NOMTE  : NOM DU TYPE ELEMENT
C
C......................................................................

      INTEGER     ALGOCR,I,J,IFA,IPGF,ISSPG
      INTEGER      JINDCO,JDONCO,JLST,IPOIDS,IVF,IDFDE,JGANO,IGEOM
      INTEGER      IDEPL,JPTINT,JAINT,JCFACE,JLONCH,JGLISS
      INTEGER     IVFF,IADZI,IAZK24,IBID,IB,JOUT1,JOUT2
      INTEGER      JOUT3,JMEMCO,NDIM,NFH,DDLC,DDLS,DDLM
      INTEGER     NPG,NPGF,INCOCA,NFE,NINTER,NNOF
      INTEGER     INDCO,GLISS,MEMCO,NFACE,CFACE(5,3)
      INTEGER     NNO,NNOS,NNOM,NNOL,PLA(27),LACT(8),NLACT,NVEC
      INTEGER     CONTAC,JBASEC,NDDL,NFISS,JFISNO
      INTEGER     JMATE,SINGU,JCOHES,JCOHEO,JHEANO,IFISS,JHEAFA,NCOMPH
      INTEGER      JTAB(2),IRET,NCOMPD,NCOMPP,NCOMPA,NCOMPB,NCOMPC
      INTEGER     NBSPG,NSPFIS,NVIT,NCOMPV
      INTEGER     ICODRE(3),NPTF,KSP,SPT
      CHARACTER*8     ELREF,TYPMA,ELREFC,JOB
      CHARACTER*8 ELC,FPG
      CHARACTER*8  FAMI,POUM
      CHARACTER*9  PHEN
      REAL*8     FFPC(27),RELA,R8PREM,EPS
      REAL*8     REAC,FFP(27),FFC(8),LC,R3BID(3),JAC
      REAL*8     PREC,ND(3),DN,SAUT(3),RR,RBID,R3BD(3)
      REAL*8     COEFCP,COEFFP,COEFCR,COEFFR,R6BID(6)
      REAL*8     P(3,3),PP(3,3),DSIDEP(6,6),TAU1(3),LAMB(3)
      REAL*8     TAU2(3),ALPHA(3),DNOR(3),DTANG(3),AM3(3),SIGMA(6)
      REAL*8     VALRES(3),COHES(3),MAT3BD(3,3),MAT6BD(6,6)
      PARAMETER    (PREC=1.D-16)
      LOGICAL     IMPRIM,LBID
C......................................................................

      CALL JEMARQ()

      IMPRIM=.FALSE.
      INCOCA=0
      NBSPG=0
      CALL VECINI(27,0.D0,FFPC)
      CALL VECINI(27,0.D0,FFP)
      CALL VECINI(8,0.D0,FFC)
      DO 1 I=1,8
        LACT(I)=0
1     CONTINUE

      CALL ELREF1(ELREF)
      CALL ELREF4(' ','RIGI',NDIM,NNO,NNOS,NPG,IPOIDS,IVF,IDFDE,JGANO)
C
      CALL XTEINI(NOMTE,NFH,NFE,SINGU,DDLC,NNOM,DDLS,NDDL,
     &            DDLM,NFISS,CONTAC)

      CALL TECAEL(IADZI,IAZK24)
      TYPMA=ZK24(IAZK24-1+3+ZI(IADZI-1+2)+3)
C
C --- ROUTINE SPECIFIQUE P2P1
C.
      CALL ELELIN(CONTAC,ELREF,ELREFC,IBID,IBID)

C     RECUPERATION DES ENTRÉES / SORTIE
      CALL JEVECH('PGEOMER','L',IGEOM)
C     DEPLACEMENT TOTAL COURANT (DEPPLU) : 'PDEPL_P'
      CALL JEVECH('PDEPL_P','L',IDEPL)
      CALL JEVECH('PINDCOI','L',JINDCO)
      CALL JEVECH('PDONCO','L',JDONCO)
      CALL TECACH('OOO','PDONCO','L',2,JTAB,IBID)
      NCOMPD = JTAB(2)
      CALL JEVECH('PGLISS','L',JGLISS)
      CALL JEVECH('PLST','L',JLST)
      CALL JEVECH('PPINTER','L',JPTINT)
      CALL JEVECH('PAINTER','L',JAINT)
      CALL JEVECH('PCFACE','L',JCFACE)
      CALL JEVECH('PLONCHA','L',JLONCH)
      CALL JEVECH('PMEMCON','L',JMEMCO)
      CALL JEVECH('PBASECO','L',JBASEC)
      IF (NFISS.GT.1) THEN
        CALL JEVECH('PFISNO','L',JFISNO)
        CALL JEVECH('PHEAVNO','L',JHEANO)
        CALL JEVECH('PHEAVFA','L',JHEAFA)
        CALL TECACH('OOO','PHEAVFA','L',2,JTAB,IRET)
        NCOMPH = JTAB(2)
      ENDIF
C     DIMENSSION DES GRANDEURS DANS LA CARTE
      CALL TECACH('OOO','PDONCO','L',2,JTAB,IRET)
      NCOMPD = JTAB(2)
      CALL TECACH('OOO','PPINTER','L',2,JTAB,IRET)
      NCOMPP = JTAB(2)
      CALL TECACH('OOO','PAINTER','L',2,JTAB,IRET)
      NCOMPA = JTAB(2)
      CALL TECACH('OOO','PBASECO','L',2,JTAB,IRET)
      NCOMPB = JTAB(2)
      CALL TECACH('OOO','PCFACE','L',2,JTAB,IRET)
      NCOMPC = JTAB(2)

      CALL JEVECH('PINCOCA','E',JOUT1)
      CALL JEVECH('PINDCOO','E',JOUT2)
      CALL JEVECH('PINDMEM','E',JOUT3)
C
C --- BOUCLE SUR LES FISSURES
C
      DO 90 IFISS = 1,NFISS
C
C --- RECUPERATION DIVERSES DONNEES CONTACT
C
         CALL XDOCON(ALGOCR,IBID  ,CFACE ,CONTAC,COEFCP,
     &               COEFFP,COEFCR,COEFFR,ELC   ,FPG   ,
     &               IFISS ,IVFF  ,JCFACE,JDONCO,JLONCH,
     &               RBID  ,NSPFIS,NCOMPD,NDIM  ,NFACE ,
     &               NINTER,NNOF  ,NOMTE ,NPGF  ,NPTF  ,
     &               RELA)
        IF(NINTER.EQ.0) GOTO 91
C
C --- RECUPERATION MATERIAU ET VARIABLES INTERNES COHESIF
C
        IF(ALGOCR.EQ.3) THEN
          CALL JEVECH('PMATERC','L',JMATE)
        CALL JEVECH('PCOHES' ,'L',JCOHES)
        CALL JEVECH('PCOHESO' ,'E',JCOHEO)
          CALL TECACH('OOO','PCOHES','L',2,JTAB,IRET)
          NCOMPV = JTAB(2)
        ENDIF
C
C       IMPRESSION (1ERE PARTIE)
C
        IF (IMPRIM) THEN
          WRITE(6,*)' '
          WRITE(6,697)
 697      FORMAT(4X,'I_IN',7X,'DN',11X,'REAC',7X,'I_OUT')
        ENDIF
C
C --- RECUP MULTIPLICATEURS ACTIFS ET LEURS INDICES
C
        CALL XMULCO(CONTAC,DDLC,DDLM,JAINT,IFISS,
     &              JHEANO,IBID,LACT,.FALSE.,LBID,NDIM,NFE,
     &              NFH,NFISS,NINTER,NLACT,NNO,
     &              NNOL,NNOM,NNOS,PLA,TYPMA)
C
C --- BOUCLE SUR LES FACETTES
C
        DO 100 IFA=1,NFACE
C
C --- BOUCLE SUR LES POINTS DE GAUSS DES FACETTES
C
          DO 110 IPGF=1,NPGF
C
C --- RECUPERATION DES STATUTS POUR LE POINT DE GAUSS
C
          ISSPG = NPGF*(IFA-1)+IPGF
          INDCO = ZI(JINDCO-1+NBSPG+ISSPG)
             DN = 0.D0
          IF(ALGOCR.EQ.3) THEN
            DO 2 I=1,NCOMPV
              COHES(I) = ZR(JCOHES+NCOMPV*(NBSPG+ISSPG-1)-1+I)
2           CONTINUE
             ENDIF
C
C --- PREPARATION DU CALCUL
C
          CALL XMPREP(CFACE ,CONTAC,ELREF ,ELREFC,ELC   ,
     &                FFC   ,FFP   ,FPG   ,JAINT ,JBASEC,
     &                JPTINT,IFA   ,IGEOM ,IPGF  ,JAC   ,
     &                JLST  ,LACT  ,ND    ,NDIM  ,NINTER,
     &                NLACT ,NNO   ,NNOS  ,NPTF  ,NVIT  ,
     &                RR    ,SINGU ,TAU1  ,TAU2)
C
C            CALCUL COMPOSANTE NORMALE SAUT DE DEPLACEMENT
C
             NVEC=1
             CALL XMMSA3(NDIM,NNO,NNOS,FFP,NDDL,NVEC,ZR(IDEPL),
     &           ZR(IDEPL),ZR(IDEPL),NFH,SINGU,RR,DDLS,DDLM,
     &           JFISNO,NFISS,IFISS,JHEAFA,NCOMPH,IFA,SAUT)
C
             IF(ALGOCR.EQ.1.OR.ALGOCR.EQ.2) THEN
               GLISS = ZI(JGLISS-1+NBSPG+ISSPG)
               MEMCO = ZI(JMEMCO-1+NBSPG+ISSPG)             
               DO 143 J = 1,NDIM
                 DN = DN + SAUT(J)*ND(J)
 143           CONTINUE
               NVEC = 1
               CALL XXLAGM(FFC   ,IDEPL ,IBID ,
     &                     LACT  ,NDIM  ,
     &                     NNOL  ,PLA   ,REAC  ,R3BID,
     &                     TAU1  ,TAU2,NVEC)

               IF (INDCO.EQ.0) THEN

C              ON REGARDE LA DISTANCE DN DES POINTS SUPPOSÉS
C              NON CONTACTANTS :
C              INTERPÉNÉPRATION EQUIVAUT À DN > 0 (ICI DN > 1E-16 )

                 IF (DN.GT.PREC) THEN
                   ZI(JOUT2-1+NBSPG+ISSPG) = 1
                   ZI(JOUT3-1+NBSPG+ISSPG) = 1
                   INCOCA = 1
                 ELSE
                   ZI(JOUT2-1+NBSPG+ISSPG) = 0
                 END IF
C
C                ON REGARDE LA REACTION POUR LES POINTS
C                SUPPOSES CONTACTANT :
               ELSE IF (INDCO.EQ.1) THEN
                 IF (REAC.GT.-1.D-3) THEN
C                  SI GLISSIERE=OUI ET IL Y A EU DU CONTACT DEJA SUR CE
C                  POINT (MEMCON=1), ALORS ON FORCE LE CONTACT
                  IF ((GLISS.EQ.1).AND.
     &                (MEMCO.EQ.1)) THEN
                    ZI(JOUT2-1+NBSPG+ISSPG) = 1
                    ZI(JOUT3-1+NBSPG+ISSPG) = 1
                  ELSE IF (GLISS.EQ.0) THEN
                    ZI(JOUT2-1+NBSPG+ISSPG) = 0
                    INCOCA = 1
                  ENDIF
                ELSE
                  ZI(JOUT2-1+NBSPG+ISSPG) = 1
                  ZI(JOUT3-1+NBSPG+ISSPG) = 1
                ENDIF
C
               ELSE
C                SI INDCO N'EST NI ÉGAL À 0 NI ÉGAL À 1:
C                PROBLEME DE STATUT DE CONTACT.
                 CALL ASSERT(INDCO.EQ.0.OR.INDCO.EQ.1)
               END IF
C
C           IMPRESSION (2EME PARTIE)
               IF (IMPRIM) THEN
                 WRITE(6,698)INDCO,DN,REAC,
     &                        ZI(JOUT2-1+NBSPG+ISSPG)
 698             FORMAT(5X,I1,4X,1PE12.5,4X,1PE12.5,4X,I1)
               ENDIF
C
             ELSE IF(ALGOCR.EQ.3) THEN
C
C              CALCUL SAUT DE DEPLACEMENT EQUIVALENT
               IF(RELA.EQ.1.D0.OR.RELA.EQ.2.D0) THEN
               JOB='ACTU_VI'
               CALL XMMSA2(NDIM  ,IPGF  ,ZI(JMATE),SAUT  ,ND   ,
     &                    TAU1 ,TAU2  ,COHES,
     &                    JOB  ,RELA,
     &                    ALPHA,DSIDEP,SIGMA       ,PP   ,DNOR,
     &                    DTANG,P   ,AM3)
               ELSEIF(RELA.EQ.3.D0.OR.RELA.EQ.4.D0) THEN
C NOUVEAUTE, IL FAUT RENSEIGNER LAMBDA
               NVEC = 1
               CALL XXLAG2(FFC   ,IDEPL ,IBID  ,LACT  ,NDIM  ,
     &                     NNOL  ,PLA   ,LAMB  ,NVEC)
               JOB='ACTU_VI'
               CALL XMMSA5(NDIM ,IPGF  ,ZI(JMATE) ,SAUT ,LAMB ,
     &                     ND   ,TAU1 ,TAU2  ,COHES ,JOB  ,
     &                     RELA ,ALPHA,MAT6BD,R6BID ,MAT3BD,
     &                     R3BD ,RBID)
               ENDIF
C
C --- ACTUALISATION VARIABLE INTERNE
C
          IF(ALGOCR.EQ.3) THEN
            DO 3 I=1,NCOMPV
             ZR(JCOHEO+NCOMPV*(NBSPG+ISSPG-1)-1+I) = ALPHA(I)
3           CONTINUE
            EPS = R8PREM()
            CALL ASSERT((ALPHA(1)+EPS).GE.COHES(1))
          ENDIF
C
C CHAMPS LIES AU CONTACT INUTILES POUR LE COHESIF
C
               ZI(JOUT2-1+NBSPG+ISSPG) = 0
               ZI(JOUT3-1+NBSPG+ISSPG) = 0
               INCOCA = 0
             ENDIF

110       CONTINUE
100     CONTINUE
        NBSPG  = NBSPG  + NSPFIS
91      CONTINUE
        JBASEC = JBASEC + NCOMPB
        JPTINT = JPTINT + NCOMPP
        JAINT  = JAINT  + NCOMPA
        JCFACE = JCFACE + NCOMPC
 90   CONTINUE

C     ENREGISTREMENT DES CHAMPS DE SORTIE
      ZI(JOUT1)=INCOCA

      CALL JEDEMA()
      END
