      SUBROUTINE XLAGSP(NOMA  ,FISS  ,ALGOLA,NDIM  ,
     &                  NLISEQ,NLISRL,NLISCO,NBASCO)      

C            CONFIGURATION MANAGEMENT OF EDF VERSION
C MODIF ALGORITH  DATE 23/07/2007   AUTEUR ABBAS M.ABBAS 
C ======================================================================
C COPYRIGHT (C) 1991 - 2005  EDF R&D                  WWW.CODE-ASTER.ORG
C THIS PROGRAM IS FREE SOFTWARE; YOU CAN REDISTRIBUTE IT AND/OR MODIFY
C IT UNDER THE TERMS OF THE GNU GENERAL PUBLIC LICENSE AS PUBLISHED BY
C THE FREE SOFTWARE FOUNDATION; EITHER VERSION 2 OF THE LICENSE, OR
C (AT YOUR OPTION) ANY LATER VERSION.
C
C THIS PROGRAM IS DISTRIBUTED IN THE HOPE THAT IT WILL BE USEFUL, BUT
C WITHOUT ANY WARRANTY; WITHOUT EVEN THE IMPLIED WARRANTY OF
C MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. SEE THE GNU
C GENERAL PUBLIC LICENSE FOR MORE DETAILS.
C
C YOU SHOULD HAVE RECEIVED A COPY OF THE GNU GENERAL PUBLIC LICENSE
C ALONG WITH THIS PROGRAM; IF NOT, WRITE TO EDF R&D CODE_ASTER,
C   1 AVENUE DU GENERAL DE GAULLE, 92141 CLAMART CEDEX, FRANCE.
C ======================================================================
C RESPONSABLE GENIAUT S.GENIAUT
C
      IMPLICIT NONE
      CHARACTER*8   NOMA,FISS
      INTEGER       NDIM
      INTEGER       ALGOLA
      CHARACTER*19  NLISEQ,NLISRL,NLISCO,NBASCO       
C      
C ----------------------------------------------------------------------
C
C ROUTINE XFEM (PREPARATION)
C
C CHOIX DE L'ESPACE DES LAGRANGES POUR LE CONTACT
C                   (VOIR BOOK VI 15/07/05) :
C    - DETERMINATION DES NOEUDS
C    - CREATION DES RELATIONS DE LIAISONS ENTRE LAGRANGE
C
C ----------------------------------------------------------------------
C
C
C IN  NDIM   : DIMENSION DE L'ESPACE
C IN  NOMA   : NOM DE L'OBJET MAILLAGE
C IN  ALGOLA : TYPE DE CREATION DES RELATIONS DE LIAISONS ENTRE LAGRANGE
C OUT NLISRL : LISTE REL. LIN. POUR V1 ET V2
C OUT NLISCO : LISTE REL. LIN. POUR V1 ET V2
C OUT NLISEQ : LISTE REL. LIN. POUR V2 SEULEMENT
C OUT NBASCO : CHAM_NO POUR BASE COVARIANTE
C
C -------------- DEBUT DECLARATIONS NORMALISEES JEVEUX -----------------
C
      CHARACTER*32 JEXNUM,JEXATR
      INTEGER ZI
      COMMON /IVARJE/ ZI(1)
      REAL*8 ZR
      COMMON /RVARJE/ ZR(1)
      COMPLEX*16 ZC
      COMMON /CVARJE/ ZC(1)
      LOGICAL ZL
      COMMON /LVARJE/ ZL(1)
      CHARACTER*8 ZK8
      CHARACTER*16 ZK16
      CHARACTER*24 ZK24
      CHARACTER*32 ZK32
      CHARACTER*80 ZK80
      COMMON /KVARJE/ ZK8(1),ZK16(1),ZK24(1),ZK32(1),ZK80(1)
C
C ---------------- FIN DECLARATIONS NORMALISEES JEVEUX -----------------
C
      INTEGER      NBCMP
      PARAMETER    (NBCMP = 12)
      CHARACTER*8  LICMPR(NBCMP)
C
      INTEGER      NBMA,NBNO,NBAR,NBARTO
      INTEGER      AR(12,2),NA,NB,NMIL,NUNOA,MXAR
      INTEGER      NUNOB,NUNOM,NOMIL
      INTEGER      IA,I,IRET,IMA,JMA    
      INTEGER      JCOOR,JCONX1,JCONX2    
      INTEGER      JCNSV,JCNSL
      REAL*8       LSNA,LSNB,LSTA,LSTB,A(3),B(3),C(3),S
      CHARACTER*8  K8BID,TYPMA
      INTEGER      IFM,NIV
      CHARACTER*19 LTNO,LNNO,GRLTNO,GRLNNO,CNSBAS
      CHARACTER*19 CNSLT,CNSLN,GRLN,GRLT
      INTEGER      JLTSV,JLNSV,JGRLNV,JGRLTV
      CHARACTER*19 TABNO,TABINT      
      INTEGER      JTABNO,JTABIN      
      INTEGER      XXMMVD,ZXBAS      
C
      DATA LICMPR/ 'X1' ,'X2' ,'X3' ,
     &             'X4' ,'X5' ,'X6' ,
     &             'X7' ,'X8' ,'X9' ,
     &             'X10','X11','X12'/
C
C ----------------------------------------------------------------------
C
      CALL JEMARQ()
      CALL INFDBG('XFEM',IFM,NIV)  
C
C --- RECUPERATION DE DONNEES RELATIVES AU MAILLAGE
C
      CALL DISMOI('F','NB_MA_MAILLA',NOMA,'MAILLAGE',NBMA,K8BID,IRET)
      CALL DISMOI('F','NB_NO_MAILLA',NOMA,'MAILLAGE',NBNO,K8BID,IRET)
      CALL JEVEUO(NOMA(1:8)//'.TYPMAIL','L',JMA)
      CALL JEVEUO(NOMA(1:8)//'.CONNEX','L',JCONX1)
      CALL JEVEUO(JEXATR(NOMA(1:8)//'.CONNEX','LONCUM'),'L',JCONX2)
      CALL JEVEUO(NOMA(1:8)//'.COORDO    .VALE','L',JCOOR)
C      
C --- DIMENSIONNEMENT DU NOMBRE MAXIMUM D'ARETES COUPEES PAR LA FISSURE
C --- PAR LE NOMBRE DE NOEUDS DU MAILLAGE (À AUGMENTER SI NÉCESSAIRE)
C
      MXAR   = NBNO 
C
C --- INITIALISATIONS
C
      ZXBAS  = XXMMVD('ZXBAS')       
      NBARTO = 0   
      CALL ASSERT(NBCMP.EQ.ZXBAS) 
      TABNO  = '&&XLAGSP.TABNO' 
      TABINT = '&&XLAGSP.TABINT' 
      CNSLT  = '&&XLAGSP.CNSLT'
      CNSLN  = '&&XLAGSP.CNSLN'
      GRLT   = '&&XLAGSP.GRLT'
      GRLN   = '&&XLAGSP.GRLN' 
      CNSBAS = '&&XLAGSP.CNSBAS'                    
C
C --- TRANSFO. CHAM_NO -> CHAM_NO_S DES LEVEL SETS
C
      LTNO   = FISS(1:8)//'.LTNO'
      LNNO   = FISS(1:8)//'.LNNO'   
      CALL CNOCNS(LTNO  ,'V',CNSLT)  
      CALL CNOCNS(LNNO  ,'V',CNSLN) 
C
C --- TRANSFO. CHAM_NO -> CHAM_NO_S DES GRADIENTS
C       
      GRLTNO = FISS(1:8)//'.GRLTNO'
      GRLNNO = FISS(1:8)//'.GRLNNO'  
      CALL CNOCNS(GRLTNO,'V',GRLT)  
      CALL CNOCNS(GRLNNO,'V',GRLN)              
C
C --- ACCES AUX CHAM_NO_S LEVEL SETS ET GRADIENTS
C
      CALL JEVEUO(CNSLT(1:19)//'.CNSV','L',JLTSV )
      CALL JEVEUO(CNSLN(1:19)//'.CNSV','L',JLNSV )
      CALL JEVEUO(GRLT(1:19) //'.CNSV','L',JGRLTV)
      CALL JEVEUO(GRLN(1:19) //'.CNSV','L',JGRLNV)
C
C --- CREATION DU CHAM_NO_S DE LA BASE COVARIANTE
C      
      CALL CNSCRE(NOMA,'NEUT_R',NBCMP,LICMPR,'V',CNSBAS)
C
C --- ACCES AU CHAM_NO_S DE LA BASE COVARIANTE
C      
      CALL JEVEUO(CNSBAS(1:19)//'.CNSV','E',JCNSV)
      CALL JEVEUO(CNSBAS(1:19)//'.CNSL','E',JCNSL)
C
C --- CREATION OBJETS DE TRAVAIL
C --- TABNO  : COL 1,2     : NOEUDS EXTREMITE
C ---        : COL 3       : NOEUD MILIEU
C --- TABINT : COL 1,2(,3) : COORDONNEES DU POINT D'INTERSECTION
C
      CALL WKVECT(TABNO ,'V V I',3*MXAR   ,JTABNO)
      CALL WKVECT(TABINT,'V V R',NDIM*MXAR,JTABIN)
C 
C --- CREATION DE LA LISTE DES ARETES COUPEES
C 
      DO 100 IMA = 1,NBMA
        CALL JENUNO(JEXNUM('&CATA.TM.NOMTM',ZI(JMA-1+IMA)),TYPMA)
C        
C ---- SI MAILLE NON VOLUMIQUE OU SURFACIQUE ON CONTINUE 
C               
        IF (TYPMA(1:4).NE.'HEXA'.AND.
     &      TYPMA(1:5).NE.'PENTA'.AND.
     &      TYPMA(1:5).NE.'TETRA'.AND.
     &      TYPMA(1:5).NE.'TRIA6'.AND.
     &      TYPMA(1:5).NE.'QUAD8') THEN
          GOTO 100
        ENDIF
C        
C --- BOUCLE SUR LES ARETES DE LA MAILLE VOLUMIQUE
C
        CALL CONARE(TYPMA,AR,NBAR)
        DO 110 IA=1,NBAR
          NA    = AR(IA,1)
          NB    = AR(IA,2)
          NUNOA = ZI(JCONX1-1+ZI(JCONX2+IMA-1)+NA-1)
          NUNOB = ZI(JCONX1-1+ZI(JCONX2+IMA-1)+NB-1)
C
C --- SI CETTE ARETE N'EST PAS COUPEE PAR LA FISSURE, ON SORT
C
          LSNA  = ZR(JLNSV-1+(NUNOA-1)+1)
          LSNB  = ZR(JLNSV-1+(NUNOB-1)+1)
          IF (LSNA*LSNB.GE.0.D0) GOTO 110
          LSTA  = ZR(JLTSV-1+(NUNOA-1)+1)
          LSTB  = ZR(JLTSV-1+(NUNOB-1)+1)
          IF (LSTA.GE.0.D0.OR.LSTB.GE.0.D0) GOTO 110

          NMIL  = NOMIL(TYPMA,IA)
          NUNOM = ZI(JCONX1-1+ZI(JCONX2+IMA-1)+NMIL-1)
C
C --- EST-CE QUE L'ARETE EST DEJA VUE ?
C
          DO 120 I = 1,NBARTO
C           ARETE DEJA VUE (ON A DEJA SON NOEUD MILIEU EN STOCK)
            IF (NUNOM.EQ.ZI(JTABNO-1+3*(I-1)+3)) GOTO 110
 120      CONTINUE
C
C --- NOUVELLE ARETE
C
          NBARTO = NBARTO+1
          IF (NBARTO.GE.MXAR) CALL U2MESS('F','XFEM_50')
          ZI(JTABNO-1+3*(NBARTO-1)+1) = NUNOA
          ZI(JTABNO-1+3*(NBARTO-1)+2) = NUNOB
          ZI(JTABNO-1+3*(NBARTO-1)+3) = NUNOM
          DO 130 I=1,NDIM
            A(I)  = ZR(JCOOR-1+3*(NUNOA-1)+I)
            B(I)  = ZR(JCOOR-1+3*(NUNOB-1)+I)
            S     = -LSNA/(LSNB-LSNA)
            C(I)  = A(I)+S*(B(I)-A(I))
            ZR(JTABIN-1+NDIM*(NBARTO-1)+I)=C(I)
 130      CONTINUE
C
C --- REMPLISSAGE DU CHAM_NO_S DE LA BASE COVARIANTE 
C 
          CALL XBASCO(NDIM  ,NUNOA ,NUNOB ,NUNOM ,
     &                A     ,B     ,C     ,S     ,
     &                JGRLNV,JGRLTV,JCNSV ,JCNSL )

 110    CONTINUE
 100  CONTINUE
C
C --- CREATION DU CHAM_NO DE LA BASE COVARIANTE
C
      IF (NBARTO.GT.0) THEN
        CALL CNSCNO(CNSBAS,' ','NON','G',NBASCO)
      ENDIF  
C
C --- CREATION DES LISTES DES RELATIONS DE LIAISONS ENTRE LAGRANGE
C 
      CALL XLAGSC(NDIM  ,NBNO  ,NBARTO,MXAR  ,ALGOLA,
     &            JTABNO,JTABIN,JLNSV ,NLISEQ,NLISRL,
     &            NLISCO)
C
C --- DESTRUCTION DES OBJETS TEMPORAIRES
C
      CALL JEDETR(TABNO)
      CALL JEDETR(TABINT)
      CALL DETRSD('CHAM_NO_S',CNSLT)
      CALL DETRSD('CHAM_NO_S',CNSLN)
      CALL DETRSD('CHAM_NO_S',GRLT)
      CALL DETRSD('CHAM_NO_S',GRLN)
C
C --- AFFICHAGE LISTE REL. LINEAIRES
C      
      IF (NIV.GE.2) THEN
        WRITE(IFM,*) '<XFEM  > LISTE DES RELATIONS LINEAIRES'
        CALL UTIMSD(IFM,-1,.TRUE.,.TRUE.,NLISEQ,1,' ')
        CALL UTIMSD(IFM,-1,.TRUE.,.TRUE.,NLISRL,1,' ')
        CALL UTIMSD(IFM,-1,.TRUE.,.TRUE.,NLISCO,1,' ')  
      ENDIF

C
      CALL JEDEMA()
      END
