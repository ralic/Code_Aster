# MODIF  DATE 05/05/2008   AUTEUR BOYERE E.BOYERE 
# TITRE SENSIBILITE EFGE_ELNO_DEPL / SIPO_ELNO_DEPL
#            CONFIGURATION MANAGEMENT OF EDF VERSION
# ======================================================================
# COPYRIGHT (C) 1991 - 2007  EDF R&D                  WWW.CODE-ASTER.ORG
# THIS PROGRAM IS FREE SOFTWARE; YOU CAN REDISTRIBUTE IT AND/OR MODIFY
# IT UNDER THE TERMS OF THE GNU GENERAL PUBLIC LICENSE AS PUBLISHED BY
# THE FREE SOFTWARE FOUNDATION; EITHER VERSION 2 OF THE LICENSE, OR
# (AT YOUR OPTION) ANY LATER VERSION.
#
# THIS PROGRAM IS DISTRIBUTED IN THE HOPE THAT IT WILL BE USEFUL, BUT
# WITHOUT ANY WARRANTY; WITHOUT EVEN THE IMPLIED WARRANTY OF
# MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. SEE THE GNU
# GENERAL PUBLIC LICENSE FOR MORE DETAILS.
#
# YOU SHOULD HAVE RECEIVED A COPY OF THE GNU GENERAL PUBLIC LICENSE
# ALONG WITH THIS PROGRAM; IF NOT, WRITE TO EDF R&D CODE_ASTER,
#    1 AVENUE DU GENERAL DE GAULLE, 92141 CLAMART CEDEX, FRANCE.
# ======================================================================
#       D'UNE POUTRE 'POU_D_E' PAR RAPPORT AUX PARAMETRES MATERIAU
#       DANS LE CADRE D'UNE ANALYSE DYNAMIQUE LINEAIRE TRANSITOIRE

DEBUT(CODE=_F(NOM='SENSD09C', NIV_PUB_WEB='INTERNET', VISU_EFICAS='NON'), PAR_LOT='OUI', DEBUG=_F(SDVERI='NON'))
# ----------------------------------------------------------------------
# Poutre a section circulaire (L=0.4m, r=0.02m, ep=0.02m)
# Sensibilite des efforts gene et contrainte par rapport a E et NU
# Conditions aux limites : appuyee-appuyee (flexion)
# La solution de reference est obtenue par difference fines
# ----------------------------------------------------------------------

pi = 3.14159
r = 0.02
ep = 0.02
l = 0.4
rho = 7800.

#           E     NU
sensible=[2.1E11, 0.3, ]

n=len(sensible)
PS=[None]*n

for i in range(n):
    PS[i]=DEFI_PARA_SENSI(VALE=sensible[i])

MAILLAGE=LIRE_MAILLAGE();

MO=AFFE_MODELE(MAILLAGE=MAILLAGE,
               AFFE=_F(GROUP_MA=('POUTRE',),
                       PHENOMENE='MECANIQUE',
                       MODELISATION='POU_D_E',),);

MAT=DEFI_MATERIAU(ELAS_FO=_F(E=PS[0],
                             RHO=rho,
                             NU=PS[1],
                             ),);

CHMAT=AFFE_MATERIAU(MAILLAGE=MAILLAGE,
                    AFFE=(_F(GROUP_MA=('POUTRE',),MATER=MAT,),),)

CARELE=AFFE_CARA_ELEM(MODELE= MO,
                      POUTRE= (_F(GROUP_MA= ( 'POUTRE',),
                                 SECTION= 'CERCLE',
                                 CARA= ('R','EP',),
                                 VALE= (r, ep,),),
                      ),)

CLIM=AFFE_CHAR_MECA(MODELE=MO,
                    DDL_IMPO=(_F(GROUP_NO='FIXE',DX=0.,DZ=0.,DRX=0.,),
                              _F(GROUP_NO='TOUT',DY=0.,DRZ=0.,),),);

MATELER=CALC_MATR_ELEM(MODELE=MO,OPTION='RIGI_MECA',
                       CHAM_MATER=CHMAT,
                       CARA_ELEM=CARELE,
                       CHARGE=CLIM);

MATELEM=CALC_MATR_ELEM(MODELE=MO,
                       OPTION='MASS_MECA',
                       CHAM_MATER=CHMAT,
                       CARA_ELEM=CARELE,
                       CHARGE=CLIM);

NUM=NUME_DDL(MATR_RIGI=MATELER);

MATASSR=ASSE_MATRICE(MATR_ELEM=MATELER,NUME_DDL=NUM);

MATASSM=ASSE_MATRICE(MATR_ELEM=MATELEM,NUME_DDL=NUM);

L_INST=DEFI_LIST_REEL(DEBUT=0.,
                       INTERVALLE=_F(JUSQU_A=0.002,NOMBRE=20))

CHARGE=AFFE_CHAR_MECA(MODELE=MO,
                    FORCE_NODALE=(_F(NOEUD='NO6',FZ =-1.E5),),);

DYT=DYNA_LINE_TRAN(MODELE=MO,CHAM_MATER=CHMAT,CARA_ELEM=CARELE,
                      MATR_MASS=MATASSM,MATR_RIGI=MATASSR,
                      INCREMENT=_F(LIST_INST=L_INST,),
                      SENSIBILITE=(PS[0],PS[1],),
                      EXCIT=(_F(CHARGE=CHARGE),),
                      NEWMARK=_F(),)

DYT = CALC_ELEM(
                reuse = DYT,
                RESULTAT= DYT,
                OPTION = ('EFGE_ELNO_DEPL','SIPO_ELNO_DEPL',),);

DYT = CALC_ELEM(
                 reuse = DYT,CHAM_MATER=CHMAT,CARA_ELEM=CARELE,
                 RESULTAT= DYT,NUME_ORDRE=20,
                 SENSIBILITE=(PS[0],PS[1]),
                 OPTION = ('EFGE_ELNO_DEPL','SIPO_ELNO_DEPL',),
                 );

T_REF_EF=POST_RELEVE_T(ACTION=_F(INTITULE='SENSIBILITE',
                      NOEUD=('NO6'),MAILLE='EL6',
                      RESULTAT=DYT,
                      NOM_CHAM='EFGE_ELNO_DEPL',
                      NUME_ORDRE=20,
                      NOM_CMP='MFY',
                      OPERATION='EXTRACTION',
                      ),);

TSREF_EF=POST_RELEVE_T(ACTION=_F(INTITULE='SENSIBILITE',
                      SENSIBILITE=tuple(PS),
                      NOEUD='NO6',MAILLE='EL6',
                      RESULTAT=DYT,
                      NOM_CHAM='EFGE_ELNO_DEPL',
                      NUME_ORDRE=20,
                      NOM_CMP='MFY',
                      OPERATION='EXTRACTION',
                      ),);

T_REF_SI=POST_RELEVE_T(ACTION=_F(INTITULE='SENSIBILITE',
                      NOEUD=('NO6'),MAILLE='EL6',
                      RESULTAT=DYT,
                      NOM_CHAM='SIPO_ELNO_DEPL',
                      NUME_ORDRE=20,
                      NOM_CMP='SMFY',
                      OPERATION='EXTRACTION',
                      ),);

TSREF_SI=POST_RELEVE_T(ACTION=_F(INTITULE='SENSIBILITE',
                      SENSIBILITE=tuple(PS),
                      NOEUD='NO6',MAILLE='EL6',
                      RESULTAT=DYT,
                      NOM_CHAM='SIPO_ELNO_DEPL',
                      NUME_ORDRE=20,
                      NOM_CMP='SMFY',
                      OPERATION='EXTRACTION',
                      ),);

#
#  Test par differences finies
#

MATD   = [None]*n
CHMATD = [None]*n
MATELR = [None]*n
MATASR = [None]*n
DYTD   = [None]*n

T_DEF  = [None]*n
T_DSI  = [None]*n
F1  = [None]*n
F2  = [None]*n
T1  = [None]*n
T2  = [None]*n

epsilon= 1.E-3

for i in range(n):
  eps=[1.]*n
  eps[i]=1.0+epsilon
  MATD[i]=DEFI_MATERIAU(ELAS=_F(E=sensible[0]*eps[0],
                                RHO=rho ,
                                NU=sensible[1]*eps[1]))

  CHMATD[i]=AFFE_MATERIAU(MAILLAGE=MAILLAGE,
                       AFFE=_F(TOUT='OUI',MATER=MATD[i],),);

  MATELR[i]=CALC_MATR_ELEM(MODELE=MO,OPTION='RIGI_MECA',
                          CHAM_MATER=CHMATD[i],CARA_ELEM=CARELE,
                          CHARGE=CLIM)

  MATASR[i]=ASSE_MATRICE(MATR_ELEM=MATELR[i],NUME_DDL=NUM)

  DYTD[i]=DYNA_LINE_TRAN(MODELE=MO,CHAM_MATER=CHMATD[i],CARA_ELEM=CARELE,
                      MATR_MASS=MATASSM,MATR_RIGI=MATASR[i],
                      INCREMENT=_F(LIST_INST=L_INST,),
                      EXCIT=(_F(CHARGE=CHARGE),),
                      NEWMARK=_F(),)

  DYTD[i] = CALC_ELEM(
                 reuse = DYTD[i],
                 RESULTAT= DYTD[i],
                 OPTION = ('EFGE_ELNO_DEPL','SIPO_ELNO_DEPL',),
                 );

# pour EFGE_ELNO_DEPL

  T_DEF[i]=POST_RELEVE_T(ACTION=_F(INTITULE='SENSIBILITE',
                                  NOEUD=('NO6'),MAILLE='EL6',
                                  RESULTAT=DYTD[i],
                                  NOM_CHAM='EFGE_ELNO_DEPL',
                                  NUME_ORDRE=20,
                                  NOM_CMP='MFY',
                                  OPERATION='EXTRACTION',
                                  ),);

  F1[i]=FORMULE(NOM_PARA=('MFY_EPS', 'MFY_REF', 'MFY_DPS'),
                VALE='abs ((MFY_EPS - MFY_REF)/%f - MFY_DPS)' %(sensible[i]*epsilon))

  T1[i]=CALC_TABLE(TABLE=TSREF_EF,
                       SENSIBILITE=PS[i],
                       ACTION=(_F(OPERATION='RENOMME',
                                  NOM_PARA=('MFY', 'MFY_DPS'),),
                               _F(OPERATION='COMB',
                                  TABLE=T_REF_EF,
                                  NOM_PARA=('NUME_ORDRE', 'NOEUD'),),
                               _F(OPERATION='RENOMME',
                                  NOM_PARA=('MFY', 'MFY_REF'),),
                               _F(OPERATION='COMB',
                                  TABLE=T_DEF[i],
                                  NOM_PARA=('NUME_ORDRE', 'NOEUD'),),
                               _F(OPERATION='RENOMME',
                                  NOM_PARA=('MFY', 'MFY_EPS'),),
                               _F(OPERATION='OPER',
                                  NOM_PARA='DIFF',
                                  FORMULE=F1[i]),
                               _F(OPERATION='EXTR',
                                  NOM_PARA=('NOEUD', 'NUME_ORDRE','INST','MFY_DPS', 'DIFF', 'MFY_REF',
                                            'MFY_EPS'),),),
                               TITRE='Comparaison entre derivee / differences finies')

  if i == 0 :
    TEST_TABLE(
       TABLE     = T1[i],
       NOM_PARA  = 'DIFF',
       TYPE_TEST = 'MAX',
       VALE      = 0.,
       CRITERE   = 'ABSOLU',
       PRECISION = 1.E-6,
       REFERENCE = 'AUTRE_ASTER',)

# pour SIPO_ELNO_DEPL

  T_DSI[i]=POST_RELEVE_T(ACTION=_F(INTITULE='SENSIBILITE',
                                  NOEUD=('NO6'),MAILLE='EL6',
                                  RESULTAT=DYTD[i],
                                  NOM_CHAM='SIPO_ELNO_DEPL',
                                  NUME_ORDRE=20,
                                  NOM_CMP='SMFY',
                                  OPERATION='EXTRACTION',
                                  ),);

  F2[i]=FORMULE(NOM_PARA=('SMFY_EPS', 'SMFY_REF', 'SMFY_DPS'),
                VALE='abs ((SMFY_EPS - SMFY_REF)/%f - SMFY_DPS)' %(sensible[i]*epsilon))

  T2[i]=CALC_TABLE(TABLE=TSREF_SI,
                       SENSIBILITE=PS[i],
                       ACTION=(_F(OPERATION='RENOMME',
                                  NOM_PARA=('SMFY', 'SMFY_DPS'),),
                               _F(OPERATION='COMB',
                                  TABLE=T_REF_SI,
                                  NOM_PARA=('NUME_ORDRE', 'NOEUD'),),
                               _F(OPERATION='RENOMME',
                                  NOM_PARA=('SMFY', 'SMFY_REF'),),
                               _F(OPERATION='COMB',
                                  TABLE=T_DSI[i],
                                  NOM_PARA=('NUME_ORDRE', 'NOEUD'),),
                               _F(OPERATION='RENOMME',
                                  NOM_PARA=('SMFY', 'SMFY_EPS'),),
                               _F(OPERATION='OPER',
                                  NOM_PARA='DIFF',
                                  FORMULE=F2[i]),
                               _F(OPERATION='EXTR',
                                  NOM_PARA=('NOEUD', 'NUME_ORDRE','INST','SMFY_DPS', 'DIFF', 'SMFY_REF',
                                            'SMFY_EPS'),),),
                               TITRE='Comparaison entre derivee / differences finies')

  if i == 0 :
     TEST_TABLE(
        TABLE     = T2[i],
        NOM_PARA  = 'DIFF',
        TYPE_TEST = 'MAX',
        VALE      = 0.,
        CRITERE   = 'ABSOLU',
        PRECISION = 1.E-4,
        REFERENCE = 'AUTRE_ASTER',)
#  else :
#     TEST_TABLE(
#        TABLE     = T2[i],
#        NOM_PARA  = 'DIFF',
#        TYPE_TEST = 'MAX',
#        VALE      = 0.,
#        CRITERE   = 'ABSOLU',
#        PRECISION = 5.E-2,
#        REFERENCE = 'AUTRE_ASTER',)

#
#  Test_Resu non regression
#

TEST_RESU(RESU=(
                _F(RESULTAT=DYT,NUME_ORDRE=20,
                   NOM_CHAM='EFGE_ELNO_DEPL',NOEUD= 'NO6',MAILLE='EL5',
                   CRITERE='RELATIF',PRECISION=1.E-5,
                   NOM_CMP='VZ',
                   VALE=(-5.E+04),REFERENCE='NON_REGRESSION',VERSION='9.0.23'),

                _F(RESULTAT=DYT,NUME_ORDRE=20,
                   NOM_CHAM='EFGE_ELNO_DEPL',NOEUD= 'NO6',MAILLE='EL5',
                   CRITERE='ABSOLU',PRECISION=1.E-10,
                   NOM_CMP='VZ',SENSIBILITE=PS_0,
                   VALE=(9.48437E-21),REFERENCE='NON_REGRESSION',VERSION='9.0.23'),

                _F(RESULTAT=DYT,NUME_ORDRE=20,
                   NOM_CHAM='EFGE_ELNO_DEPL',NOEUD= 'NO6',MAILLE='EL5',
                   CRITERE='ABSOLU',PRECISION=1.E-10,
                   NOM_CMP='VZ',SENSIBILITE=PS_1,
                   VALE=(0.E+00),REFERENCE='NON_REGRESSION',VERSION='9.0.23'),

                _F(RESULTAT=DYT,NUME_ORDRE=20,
                   NOM_CHAM='EFGE_ELNO_DEPL',NOEUD= 'NO6',MAILLE='EL5',
                   CRITERE='RELATIF',PRECISION=1.E-5,
                   NOM_CMP='MFY',
                   VALE=(-1.49805E+03),REFERENCE='NON_REGRESSION',VERSION='9.0.23'),

                _F(RESULTAT=DYT,NUME_ORDRE=20,
                   NOM_CHAM='EFGE_ELNO_DEPL',NOEUD= 'NO6',MAILLE='EL5',
                   CRITERE='ABSOLU',PRECISION=1.E-10,
                   NOM_CMP='MFY',SENSIBILITE=PS_0,
                   VALE=(1.00054E-08),REFERENCE='NON_REGRESSION',VERSION='9.0.23'),

                _F(RESULTAT=DYT,NUME_ORDRE=20,
                   NOM_CHAM='EFGE_ELNO_DEPL',NOEUD= 'NO6',MAILLE='EL5',
                   CRITERE='ABSOLU',PRECISION=1.E-10,
                   NOM_CMP='MFY',SENSIBILITE=PS_1,
                   VALE=(0.E+00),REFERENCE='NON_REGRESSION',VERSION='9.0.23'),

                _F(RESULTAT=DYT,NUME_ORDRE=20,
                   NOM_CHAM='SIPO_ELNO_DEPL',NOEUD= 'NO6',MAILLE='EL5',
                   CRITERE='RELATIF',PRECISION=1.E-5,
                   NOM_CMP='SVZ',
                   VALE=(-3.97887E+07),REFERENCE='NON_REGRESSION',VERSION='9.0.23'),

                _F(RESULTAT=DYT,NUME_ORDRE=20,
                   NOM_CHAM='SIPO_ELNO_DEPL',NOEUD= 'NO6',MAILLE='EL5',
                   CRITERE='ABSOLU',PRECISION=1.E-10,
                   NOM_CMP='SVZ',SENSIBILITE=PS_0,
                   VALE=(7.54742E-20),REFERENCE='NON_REGRESSION',VERSION='9.0.23'),

                _F(RESULTAT=DYT,NUME_ORDRE=20,
                   NOM_CHAM='SIPO_ELNO_DEPL',NOEUD= 'NO6',MAILLE='EL5',
                   CRITERE='ABSOLU',PRECISION=1.E-10,
                   NOM_CMP='SVZ',SENSIBILITE=PS_1,
                   VALE=(0.E+00),REFERENCE='NON_REGRESSION',VERSION='9.0.23'),

                _F(RESULTAT=DYT,NUME_ORDRE=20,
                   NOM_CHAM='SIPO_ELNO_DEPL',NOEUD= 'NO6',MAILLE='EL5',
                   CRITERE='RELATIF',PRECISION=1.E-5,
                   NOM_CMP='SMFY',
                   VALE=(-2.38422E+08),REFERENCE='NON_REGRESSION',VERSION='9.0.23'),

                _F(RESULTAT=DYT,NUME_ORDRE=20,
                   NOM_CHAM='SIPO_ELNO_DEPL',NOEUD= 'NO6',MAILLE='EL5',
                   CRITERE='RELATIF',PRECISION=1.E-5,
                   NOM_CMP='SMFY',SENSIBILITE=PS_0,
                   VALE=(1.59241E-03),REFERENCE='NON_REGRESSION',VERSION='9.0.23'),

                _F(RESULTAT=DYT,NUME_ORDRE=20,
                   NOM_CHAM='SIPO_ELNO_DEPL',NOEUD= 'NO6',MAILLE='EL5',
                   CRITERE='ABSOLU',PRECISION=1.E-10,
                   NOM_CMP='SMFY',SENSIBILITE=PS_1,
                   VALE=(0.E+00),REFERENCE='NON_REGRESSION',VERSION='9.0.23'),
               ),)

FIN()


